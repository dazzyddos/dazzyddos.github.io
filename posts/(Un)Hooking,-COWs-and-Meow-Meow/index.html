<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="(Un)Hooking, COWs and Meow Meow" /><meta name="author" content="Dazzy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Konichiwa to all my readers! Today, I’m sharing a concise blog post centered on a query that arose during a malware development training session I was conducting. This post contains my observations and experiments in response to that question. Below, you’ll find a screenshot of the exact query posed by one of the participants. At that time, I wasn’t entirely sure of the answer, so I promised to research and circle back. To ensure I was on the right track and not diverging from the original question, I reached out to him today on Discord for a quick recap :P" /><meta property="og:description" content="Konichiwa to all my readers! Today, I’m sharing a concise blog post centered on a query that arose during a malware development training session I was conducting. This post contains my observations and experiments in response to that question. Below, you’ll find a screenshot of the exact query posed by one of the participants. At that time, I wasn’t entirely sure of the answer, so I promised to research and circle back. To ensure I was on the right track and not diverging from the original question, I reached out to him today on Discord for a quick recap :P" /><link rel="canonical" href="https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/" /><meta property="og:url" content="https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/" /><meta property="og:site_name" content="Dazzy Ddos" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-10-14T03:15:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(Un)Hooking, COWs and Meow Meow" /><meta name="twitter:site" content="@dazzyddos" /><meta name="twitter:creator" content="@Dazzy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Dazzy"},"description":"Konichiwa to all my readers! Today, I’m sharing a concise blog post centered on a query that arose during a malware development training session I was conducting. This post contains my observations and experiments in response to that question. Below, you’ll find a screenshot of the exact query posed by one of the participants. At that time, I wasn’t entirely sure of the answer, so I promised to research and circle back. To ensure I was on the right track and not diverging from the original question, I reached out to him today on Discord for a quick recap :P","url":"https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/","@type":"BlogPosting","headline":"(Un)Hooking, COWs and Meow Meow","dateModified":"2023-10-18T08:43:48+03:00","datePublished":"2023-10-14T03:15:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/"},"@context":"https://schema.org"}</script><title>(Un)Hooking, COWs and Meow Meow | Dazzy Ddos</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/25081660?s=460&u=d7eb9a459d672ab9b0b1ccead34de3233e2843ee&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dazzy Ddos</a></div><div class="site-subtitle font-italic"></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/dazzyddos" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/dazzyddos" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>(Un)Hooking, COWs and Meow Meow</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>(Un)Hooking, COWs and Meow Meow</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Oct 14, 2023, 3:15 AM +0300" > Oct 14, 2023 <i class="unloaded">2023-10-14T03:15:00+03:00</i> </span> by <span class="author"> Dazzy </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 18, 2023, 11:13 AM +0530" > Oct 18, 2023 <i class="unloaded">2023-10-18T08:43:48+03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2048 words">11 min</span></div></div><div class="post-content"><p>Konichiwa to all my readers! Today, I’m sharing a concise blog post centered on a query that arose during a malware development training session I was conducting. This post contains my observations and experiments in response to that question. Below, you’ll find a screenshot of the exact query posed by one of the participants. At that time, I wasn’t entirely sure of the answer, so I promised to research and circle back. To ensure I was on the right track and not diverging from the original question, I reached out to him today on Discord for a quick recap :P <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014103148.png" alt="" /></p><p>TLDR</p><blockquote><p>Yes, when you use NtMapViewOfFile and NtMapViewOfSection to load and map a copy of ntdll.dll from the disk into our process, and then attempt to modify its .text section of ntdll in memory with it’s .text section, Copy On Write will indeed be triggered. This is because the memory pages of shared libraries like ntdll.dll are typically marked as read-only, and any write operation to these pages will invoke the COW. As a result of this, the specific page (or pages) we’re trying to write to will be duplicated for our process, ensuring that other processes using the same ntdll.dll are not affected. Now, regarding the question of whether two ntdll.dll instances would be loaded into your process, technically, yes. One instance is the original ntdll.dll that’s loaded into every process by the OS. The second instance is the one you manually mapped using NtMapViewOfFile / NtMapViewOfSection. It’s also important to understand that the manually mapped ntdll.dll will not be used by the system or other applications unless explicitly done so by your process [GetProcAddress(yourNtdll, “NtCreateFile”)]</p></blockquote><p>Now for those who wants to read through my struggles and noob debugger examples, please proceed to read through :P</p><p>When an OS loads shared libraries or system DLLs (like <code class="language-plaintext highlighter-rouge">ntdll.dll</code>), it tries to optimize memory usage. Instead of loading a new instance of the same library into memory for every process that requires it, the OS loads the library once and then maps it into the virtual address space of each process that uses it. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014103647.png" alt="" /></p><p>This approach is memory-efficient, but there’s a potential problem: what if one process tries to modify that shared library? If it was truly shared, this would modify the library for every process, which is undesirable. Let’s test it out. I am going to be using Frida to hook(patch) a specific function (NtCreateFile in our example) and let’s see if it’s been modified for all other process’s as well</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">pNtCreateFile</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="dl">"</span><span class="s2">ntdll.dll</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">NtCreateFile</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">pNtCreateFile</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">onEnter</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">[+] Called NtCreateFile [+]</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014104832.png" alt="" /> From what we can see above, the <code class="language-plaintext highlighter-rouge">NtCreateFile</code> in the Notepad process got modified because of hooking, while the Calculator’s stayed untouched, even though they’re hanging out at the same memory address.</p><p>Copy on Write (CoW) is the answer. Initially, memory pages of the shared library are marked as read-only. When a process (like Notepad in our example) tries to write to a page of this shared memory, a page fault is generated because of the attempt to write to a read-only page. The OS handles this page fault by creating a private copy of modified page (not the whole DLL) for the writing process, then allowing the write to proceed on this private copy. Other processes still use the original shared page, and thus remain unaffected. This copied page replaces the shared page in your process’s page table.</p><p>Let’s look into the memory protection for the NTDLL and the NtCreateFile memory page in windbg. Before hooking <strong>NtCreateFile</strong> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014105438.png" alt="" /></p><p>Checking protection of the memory page where the NtCreateFile is residing <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014105507.png" alt="" /> Protection of the whole <strong>ntdll</strong> region <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014105549.png" alt="" /></p><p>After hooking NtCreateFile <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014091126.png" alt="" /></p><p>If we take a look at the protection of the ntdll region, you’ll see that the whole ntdll region is not affected by COW. Only the section/page where the <code class="language-plaintext highlighter-rouge">NtCreateFile</code> resides is affected and modified. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014091301.png" alt="" /></p><p>The memory in modern operating systems is managed in pages, typically of sizes like 4KB. When you modify a specific location in memory, only the page containing that location is affected. If the modification triggers a Copy-on-Write (CoW) event, only that specific page will be copied and made writable, not the entire region or module. So, if you change bytes of the <code class="language-plaintext highlighter-rouge">NtCreateFile</code> API function in <code class="language-plaintext highlighter-rouge">ntdll.dll</code>, only the page (or pages) containing that API function will be subject to CoW. The rest of the <code class="language-plaintext highlighter-rouge">ntdll.dll</code> region will remain unchanged and continue to reference the original shared pages. By only duplicating the modified pages rather than the entire module, the OS achieves efficiency in memory use, ensures that changes are isolated to the specific process making the modifications, and avoids unnecessary memory consumption, striking a balance between performance and the security of ensuring processes don’t inadvertently affect one another.</p><p>Another question that you may ask now is how does our process(Notepad.exe) know which NtCreateFile to call, the one modified and private to our memory space or the one that resides in shared memory region? The answer to this question was partially answered above in our statement</p><blockquote><p>due to the Copy-on-Write (COW) mechanism, the OS makes a private copy of the modified page (not the whole DLL) just for your process. This copied page replaces the shared page in your process’s PAGE TABLE.</p></blockquote><p>Each process has its own virtual address space, and the OS, with the help of the MMU (Memory Management Unit), translates these virtual addresses to physical addresses. The page table is the core data structure used for this translation. When you modified <code class="language-plaintext highlighter-rouge">NtCreateFile</code>, the page table entry for that specific page was updated to point to the new, private page, while other entries remained unchanged and still point to shared pages. So, when your process calls the <code class="language-plaintext highlighter-rouge">NtCreateFile</code> function, it looks up the address in its own page table. Since the page table entry for that page now points to the private copy (thanks to your modification and COW), your process will execute the modified <code class="language-plaintext highlighter-rouge">NtCreateFile</code> function.</p><p>We can observe this behavior with <code class="language-plaintext highlighter-rouge">VMMap</code> (part of Sysinternals Suite) too Before Hooking <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014093256.png" alt="" /></p><p>After patching the <code class="language-plaintext highlighter-rouge">NtCreateFile</code> function, it’s evident that the memory page where <code class="language-plaintext highlighter-rouge">NtCreateFile</code> resides has undergone a change. Its permissions have shifted from <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READ</code> to <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code>. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014093916.png" alt="" /></p><p>So, I got a bit curious and wanted to try out some quirky experiments, even if they didn’t seem to make a whole lot of sense. I created up a simple C code to load two <code class="language-plaintext highlighter-rouge">ntdll</code>s. Fun fact: if you try using <code class="language-plaintext highlighter-rouge">LoadLibrary</code> to load <code class="language-plaintext highlighter-rouge">ntdll</code> again, it won’t bother if it spots the DLL already chilling in memory. So workaround would be to just copy <code class="language-plaintext highlighter-rouge">ntdll.dll</code> to a different folder and loaded it from there.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"Before Loading another ntdll</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">getchar</span><span class="p">();</span>
     <span class="n">HMODULE</span> <span class="n">ntdllNew</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">hacke</span><span class="se">\\</span><span class="s">Desktop</span><span class="se">\\</span><span class="s">newntdll.dll"</span><span class="p">);</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"After Loading another ntdll</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"ntdllNew: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntdllNew</span><span class="p">);</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"NtCreateFile of original NTDLL %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">),</span><span class="s">"NtCreateFile"</span><span class="p">));</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"NtCreateFile of new NTDLL %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">ntdllNew</span><span class="p">,</span><span class="s">"NtCreateFile"</span><span class="p">));</span>
     <span class="n">getchar</span><span class="p">();</span>

     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014101345.png" alt="" /></p><p>So, I went ahead and hooked <code class="language-plaintext highlighter-rouge">NtCreateFile</code> using Frida. Now, when I peeked inside the debugger, Only the <code class="language-plaintext highlighter-rouge">ntdll</code>’s <code class="language-plaintext highlighter-rouge">NtCreateFile</code> was modified. And it kinda makes sense cause both DLLs are hanging out in different regions of memory, and they aren’t sharing the space. So, a change in one spot won’t mess with the other. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014101507.png" alt="" /></p><p>So now at this moment we know when you modify a page in memory, the operating system doesn’t copy the entire <code class="language-plaintext highlighter-rouge">.text</code> region, but only the specific memory page that’s being modified due to the Copy-On-Write (COW) mechanism. So if you’re patching or modifying just one API function, like <code class="language-plaintext highlighter-rouge">NtCreateFile</code> or <code class="language-plaintext highlighter-rouge">MessageBoxA</code>, and it resides within a single page, only that specific page will be copied and made private to your process. If the modification spans multiple pages, then those specific pages will be copied. The rest of the <code class="language-plaintext highlighter-rouge">.text</code> region, and any other part of <code class="language-plaintext highlighter-rouge">ntdll.dll</code> that you haven’t touched, will remain as shared read-only pages among all processes that use <code class="language-plaintext highlighter-rouge">ntdll.dll</code>.</p><p>Now to better understand the confirm the above theory, I took another ntdll unhooking example ired.team</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">process</span> <span class="o">=</span> <span class="n">GetCurrentProcess</span><span class="p">();</span>
	<span class="n">MODULEINFO</span> <span class="n">mi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">HMODULE</span> <span class="n">ntdllModule</span> <span class="o">=</span> <span class="n">GetModuleHandleA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">);</span>

     <span class="n">printf</span><span class="p">(</span><span class="s">"Before UnHooking...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">getchar</span><span class="p">();</span>
	
	<span class="n">GetModuleInformation</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">ntdllModule</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mi</span><span class="p">));</span>
	<span class="n">LPVOID</span> <span class="n">ntdllBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">mi</span><span class="p">.</span><span class="n">lpBaseOfDll</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">ntdllFile</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Users</span><span class="se">\\</span><span class="s">hacke</span><span class="se">\\</span><span class="s">Desktop</span><span class="se">\\</span><span class="s">newntdll.dll"</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">HANDLE</span> <span class="n">ntdllMapping</span> <span class="o">=</span> <span class="n">CreateFileMapping</span><span class="p">(</span><span class="n">ntdllFile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_READONLY</span> <span class="o">|</span> <span class="n">SEC_IMAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">LPVOID</span> <span class="n">ntdllMappingAddress</span> <span class="o">=</span> <span class="n">MapViewOfFile</span><span class="p">(</span><span class="n">ntdllMapping</span><span class="p">,</span> <span class="n">FILE_MAP_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">PIMAGE_DOS_HEADER</span> <span class="n">hookedDosHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">ntdllBase</span><span class="p">;</span>
	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">hookedNtHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">ntdllBase</span> <span class="o">+</span> <span class="n">hookedDosHeader</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">WORD</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hookedNtHeader</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PIMAGE_SECTION_HEADER</span> <span class="n">hookedSectionHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">IMAGE_FIRST_SECTION</span><span class="p">(</span><span class="n">hookedNtHeader</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">IMAGE_SIZEOF_SECTION_HEADER</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="s">".text"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DWORD</span> <span class="n">oldProtection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">BOOL</span> <span class="n">isProtected</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">((</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">ntdllBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span> <span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtection</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">ntdllBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">ntdllMappingAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD_PTR</span><span class="p">)</span><span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span> <span class="n">hookedSectionHeader</span><span class="o">-&gt;</span><span class="n">Misc</span><span class="p">.</span><span class="n">VirtualSize</span><span class="p">);</span>
			<span class="c1">//isProtected = VirtualProtect((LPVOID)((DWORD_PTR)ntdllBase + (DWORD_PTR)hookedSectionHeader-&gt;VirtualAddress), hookedSectionHeader-&gt;Misc.VirtualSize, oldProtection, &amp;oldProtection); // commented out to see the RWX region of .text</span>
		<span class="p">}</span>
	<span class="p">}</span>

     <span class="n">printf</span><span class="p">(</span><span class="s">"After Unhooking...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
     <span class="n">getchar</span><span class="p">();</span>
	
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">process</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">ntdllFile</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">ntdllMapping</span><span class="p">);</span>
	<span class="n">FreeLibrary</span><span class="p">(</span><span class="n">ntdllModule</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In the code above, we are going to be overwriting the complete .text region of the NTDLL section. Using VMMap to analyze the program, it became evident that no separate pages were generated this time. Instead, the entire <code class="language-plaintext highlighter-rouge">.text</code> region of <code class="language-plaintext highlighter-rouge">ntdll.dll</code> was duplicated locally for the process. The screenshot below shows the state of NTDLL .text region before overwriting (unhooking), it’s evident that it’s residing in the shared memory region. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231015113013.png" alt="" /></p><p>After unhooking (overwriting) has been performed, the same .text region has now been copied locally and has now become a private region for our process. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231015113243.png" alt="" /></p><p>The same behavior I observed with codes like Peruns Fart also where we modify the .text region of NTDLL in process.</p><p>I prepared few diagrams also who like to visualize things while learning like me :D</p><p>The diagram below is a representation of multiple processes reading from the same shared memory space of ntdll.dll library <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014230910.png" alt="" /></p><p>The diagram below illustrates that when our process attempts a write operation (such as hooking or patching) on a specific API function address, the OS will generate a private local copy of the entire page containing that specific API function within our process’s memory. Subsequently, the OS will adjust the page table to point to this locally mapped page. As a result, whenever our function invokes that specific API (in our instance, NtCreateFile), it will reference the local copy instead. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014231014.png" alt="" /></p><p>“The diagram below illustrates how, when our process attempts to overwrite the .text region of a particular shared library, the OS, in response to a COW (Copy On Write) trigger, will create a dedicated local copy of the entire .text region within our process’s memory. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231014231228.png" alt="" /></p><h4 id="update-10182023">Update (10/18/2023)</h4><p>In response to Ali Hadi’s insightful comment, I decided to delve deeper into the behavior of COW, specifically concerning the DLLs listed in the KnownDLLs object.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231018103831.png" alt="" /></p><p><strong>Background on KnownDLLs Object</strong></p><blockquote><p>KnownDLLs is a mechanism that Windows uses to optimize the loading of certain system libraries. DLLs listed in KnownDLLs are shared across all processes to speed up the system’s performance. When a process needs to load a DLL, the system first checks if it’s a KnownDLL. If it is, the system uses the already-loaded copy from the shared section instead of loading a new one from disk.</p></blockquote><p>To address Ali’s query, whether COW is exclusively triggered for DLLs present in KnownDLLs, I began by examining the content of the KnownDLLs object for my Windows</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231018103912.png" alt="" /></p><p>Notably, <code class="language-plaintext highlighter-rouge">amsi.dll</code> was absent from the list. This was intriguing since <code class="language-plaintext highlighter-rouge">amsi.dll</code> is frequently utilized by many processes. Furthermore, I noticed the omission of <code class="language-plaintext highlighter-rouge">NTDLL</code> as well. Taking <code class="language-plaintext highlighter-rouge">amsi.dll</code> as a test case, I reviewed its memory mapping using vmmap: Before Hooking <strong>AmsiScanBuffer</strong> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231018105104.png" alt="" /></p><p>Subsequently, I hooked the <code class="language-plaintext highlighter-rouge">AmsiScanBuffer</code>. The memory mapping post-hooking revealed the creation of a new private memory map: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/dazzyddos/dazzyddos.github.io/master/Images/copyonwrite/Pasted%20image%2020231018105600.png" alt="" /></p><p><strong>Conclusion:</strong> The investigation above indicates that COW is not restricted to DLLs in the KnownDLLs object. Hooking a function in <code class="language-plaintext highlighter-rouge">amsi.dll</code> (which isn’t part of KnownDLLs) led to COW behavior, evidenced by the creation of a new private memory map.</p><h3 id="resources-and-references">Resources and References</h3><p>https://security.stackexchange.com/questions/61771/is-api-hooking-done-by-a-process-in-a-shared-page-visible-to-all-other-processe</p><p>https://www.ired.team/offensive-security/defense-evasion/how-to-unhook-a-dll-using-c++</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/red-teaming/'>Red Teaming</a>, <a href='/categories/defense-evasion/'>Defense Evasion</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hooking/" class="post-tag no-text-decoration" >hooking</a> <a href="/tags/unhooking/" class="post-tag no-text-decoration" >unhooking</a> <a href="/tags/frida/" class="post-tag no-text-decoration" >frida</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(Un)Hooking, COWs and Meow Meow - Dazzy Ddos&url=https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(Un)Hooking, COWs and Meow Meow - Dazzy Ddos&u=https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=(Un)Hooking, COWs and Meow Meow - Dazzy Ddos&url=https://dazzyddos.github.io/posts/(Un)Hooking,-COWs-and-Meow-Meow/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/(Un)Hooking,-COWs-and-Meow-Meow/">(Un)Hooking, COWs and Meow Meow</a><li><a href="/posts/Naughty_Hooking_Detoxifying_Memory/">Naughty Hooking Detoxifying Memory Before Doing Crime</a><li><a href="/posts/Remote-Process-Enumeration-with-WTS-Set-Of-APIs/">Remote Process Enumeration with WTS Set of Windows APIs</a><li><a href="/posts/AMSI-Bypass/">Defense Evasion Series Part 1 AMSI Bypass</a><li><a href="/posts/Automating-Phishing-Infrastructure-with-terraform-on-AWS/">Automating Phishing Infrastructure with terraform on AWS</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Naughty_Hooking_Detoxifying_Memory/"><div class="card-body"> <span class="timeago small" > Aug 18, 2023 <i class="unloaded">2023-08-18T03:15:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Naughty Hooking Detoxifying Memory Before Doing Crime</h3><div class="text-muted small"><p> Introduction Konnichiwa my dear readers, I trust it’s been a while since my last update. I’m thrilled to be back, and I’m excited to delve into an intriguing, yet undeniably significant aspect of...</p></div></div></a></div><div class="card"> <a href="/posts/Abusing_Exclusions_To_Evade_Detection/"><div class="card-body"> <span class="timeago small" > Aug 11 <i class="unloaded">2024-08-11T03:15:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Abusing Exclusions To Evade Detection</h3><div class="text-muted small"><p> Long time dear readers. In this blog post we’ll see how to abuse a common feature in Antivirus and EDRs that’s not much talked about. I am using Defender AV as that’s common and by default across a...</p></div></div></a></div><div class="card"> <a href="/posts/AMSI-Bypass/"><div class="card-body"> <span class="timeago small" > Aug 18, 2021 <i class="unloaded">2021-08-18T09:10:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Defense Evasion Series Part 1 AMSI Bypass</h3><div class="text-muted small"><p> Introduction Hello Folks. This is the beginning of a new blog post series on various Defense Evasion techniques. In Part 1, we will look into what is AMSI, how it works and how to bypass it. Prer...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Naughty_Hooking_Detoxifying_Memory/" class="btn btn-outline-primary" prompt="Older"><p>Naughty Hooking Detoxifying Memory Before Doing Crime</p></a> <a href="/posts/Abusing_Exclusions_To_Evade_Detection/" class="btn btn-outline-primary" prompt="Newer"><p>Abusing Exclusions To Evade Detection</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/dazzyddos">dazzy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/hooking/">hooking</a> <a class="post-tag" href="/tags/tryhackme/">tryhackme</a> <a class="post-tag" href="/tags/unhooking/">unhooking</a> <a class="post-tag" href="/tags/walkthrough/">walkthrough</a> <a class="post-tag" href="/tags/amsi-bypass/">amsi bypass</a> <a class="post-tag" href="/tags/av-bypass/">av bypass</a> <a class="post-tag" href="/tags/aws/">aws</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dazzyddos.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
